# =============================================================================
# HAProxy 3.3 配置文件
# 适用于 2核2G 服务器，优化性能和安全性
# =============================================================================

global
# 日志配置
log stdout format raw local0 info

# 性能优化
maxconn 2000                        # 最大并发连接数（2G内存适中值）
nbthread 2                          # 线程数（与CPU核心数匹配）

# 管理接口
stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
stats timeout 30s

# 安全配置
user haproxy
group haproxy

# SSL/TLS 优化
ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

# 性能调优
tune.ssl.default-dh-param 2048
tune.bufsize 32768

# =============================================================================
# 默认配置
# =============================================================================
defaults
mode http
log global
option httplog
option dontlognull
option http-server-close
option forwardfor except 127.0.0.0/8
option redispatch

# 超时配置
timeout connect 10s
timeout client 60s
timeout server 60s
timeout http-request 10s
timeout http-keep-alive 10s
timeout queue 30s
timeout tunnel 3600s

# 重试配置
retries 3

# 错误页面
errorfile 400 /usr/local/etc/haproxy/errors/400.http
errorfile 403 /usr/local/etc/haproxy/errors/403.http
errorfile 408 /usr/local/etc/haproxy/errors/408.http
errorfile 500 /usr/local/etc/haproxy/errors/500.http
errorfile 502 /usr/local/etc/haproxy/errors/502.http
errorfile 503 /usr/local/etc/haproxy/errors/503.http
errorfile 504 /usr/local/etc/haproxy/errors/504.http

# =============================================================================
# 统计监控面板
# =============================================================================
listen stats
bind *:8404
mode http
stats enable
stats uri /stats
stats refresh 10s
stats show-legends
stats show-node
stats admin if LOCALHOST

# 可选：添加认证
# stats auth admin:your_password_here

# =============================================================================
# HTTP 前端（自动跳转到 HTTPS）
# =============================================================================
frontend http_in
bind *:80
mode http

# 健康检查例外（不跳转）
acl is_health_check path /health /ready

# ACME 挑战例外（Let's Encrypt）
acl is_acme_challenge path_beg /.well-known/acme-challenge/

# 健康检查和 ACME 直接转发
use_backend caddy_servers if is_health_check or is_acme_challenge

# 其他请求跳转到 HTTPS
http-request redirect scheme https code 301 unless is_health_check or is_acme_challenge

# =============================================================================
# HTTPS 前端
# =============================================================================
frontend https_in
bind *:443 ssl crt /etc/ssl/certs/mysite.pem alpn h2,http/1.1
mode http

# 安全头部
http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
http-response set-header X-Frame-Options "SAMEORIGIN"
http-response set-header X-Content-Type-Options "nosniff"
http-response set-header X-XSS-Protection "1; mode=block"

# 转发真实 IP
http-request set-header X-Forwarded-Proto https
http-request set-header X-Forwarded-Port 443

# 路由规则
# acl is_domain hdr(host) -i yourdomain.com www.yourdomain.com
# use_backend caddy_servers if is_domain

default_backend caddy_servers

# =============================================================================
# Caddy 后端服务器
# =============================================================================
backend caddy_servers
mode http
balance roundrobin

# 健康检查
option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
http-check expect status 200

# 后端服务器配置
# check: 启用健康检查
# inter: 检查间隔 2秒
# rise: 连续成功2次标记为UP
# fall: 连续失败3次标记为DOWN
# maxconn: 单服务器最大连接数
server caddy1 caddy:80 check inter 2s rise 2 fall 3 maxconn 500

# 如果有多个 Caddy 实例，可以添加更多服务器
# server caddy2 caddy2:80 check inter 2s rise 2 fall 3 maxconn 500 backup

# =============================================================================
# 配置结束
# 
# 使用说明：
# 1. 替换 /etc/ssl/certs/mysite.pem 为你的证书路径
# 2. 替换 yourdomain.com 为你的实际域名
# 3. 根据需要调整 maxconn 和超时时间
# 4. 生产环境建议为 stats 面板添加认证
# =============================================================================