name: Sync PHP Base Images

on:
  workflow_dispatch:
    inputs:
      sync_php_base:
        description: "同步 PHP 基础镜像 (cli, fpm, simple-cli)"
        type: boolean
        default: true
      sync_php_octane:
        description: "同步 PHP Octane 镜像 (franken, roadrunner)"
        type: boolean
        default: false
      sync_php_xdebug:
        description: "同步 PHP Xdebug 镜像 (fpm-xdebug)"
        type: boolean
        default: false
      php_versions:
        description: "PHP 版本 (逗号分隔，如: 8.4,8.5)"
        required: false
        type: string
        default: "8.4,8.5"
      tag:
        description: "镜像子标签 (如: latest)"
        required: false
        type: string
        default: "latest"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # 定义镜像映射
          declare -A PHP_GROUPS
          PHP_GROUPS["php-base"]="php-base-cli,php-base-cli-trixie,php-base-fpm,php-base-fpm-trixie,php-base-simple-cli,php-base-simple-cli-trixie"
          PHP_GROUPS["php-octane"]="php-base-franken,php-base-franken-trixie,php-base-roadrunner,php-base-roadrunner-trixie"
          PHP_GROUPS["php-xdebug"]="php-base-fpm-xdebug,php-base-fpm-xdebug-trixie"

          PHP_VERSIONS="${{ inputs.php_versions }}"
          SUB_TAG="${{ inputs.tag }}"
          TARGET_NS="${{ secrets.TENCENT_REGISTRY_NAMESPACE || 'jiaoio' }}"

          MATRIX_JSON='{"include":[]}'

          # 处理逻辑
          add_to_matrix() {
            local img=$1
            local tag=$2
            local src="docker.io/jiaoio/${img}:${tag}"
            local dst="ccr.ccs.tencentyun.com/${TARGET_NS}/${img}:${tag}"
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ".include += [{\"name\":\"${img}:${tag}\", \"src\":\"${src}\", \"dst\":\"${dst}\"}]")
          }

          IFS=',' read -ra VERSIONS <<< "$PHP_VERSIONS"
          
          # 基础镜像
          if [ "${{ inputs.sync_php_base }}" == "true" ]; then
            for img in ${PHP_GROUPS["php-base"]//,/ }; do
              for v in "${VERSIONS[@]}"; do
                v=$(echo $v | xargs)
                add_to_matrix "$img" "$v-$SUB_TAG"
                add_to_matrix "$img" "$v-latest"
              done
            done
          fi

          # Octane 镜像
          if [ "${{ inputs.sync_php_octane }}" == "true" ]; then
            for img in ${PHP_GROUPS["php-octane"]//,/ }; do
              for v in "${VERSIONS[@]}"; do
                v=$(echo $v | xargs)
                add_to_matrix "$img" "$v-$SUB_TAG"
                add_to_matrix "$img" "$v-latest"
              done
            done
          fi

          # Xdebug 镜像
          if [ "${{ inputs.sync_php_xdebug }}" == "true" ]; then
            for img in ${PHP_GROUPS["php-xdebug"]//,/ }; do
              for v in "${VERSIONS[@]}"; do
                v=$(echo $v | xargs)
                add_to_matrix "$img" "$v-$SUB_TAG"
                add_to_matrix "$img" "$v-fpm-$SUB_TAG"
                add_to_matrix "$img" "$v-latest"
              done
            done
          fi

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          # 调试信息 (不会包含 secret，因为 MATRIX_JSON 只是镜像名和公开地址)
          echo "Generated Matrix: $MATRIX_JSON"

  sync:
    needs: generate-matrix
    # 使用 contains 检查是否有内容，比直接索引更安全
    if: ${{ needs.generate-matrix.outputs.matrix != '' && contains(needs.generate-matrix.outputs.matrix, 'include') && fromJson(needs.generate-matrix.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # 即使一个镜像同步失败，也不停止其他的
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    
    name: Sync ${{ matrix.name }}
    steps:
      - name: Set up Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to Registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | skopeo login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin docker.io
          echo "${{ secrets.TENCENT_REGISTRY_PASSWORD }}" | skopeo login --username "${{ secrets.TENCENT_REGISTRY_USERNAME }}" --password-stdin ccr.ccs.tencentyun.com

      - name: Copy Image
        run: |
          skopeo copy \
            --all \
            --src-tls-verify=false \
            --dest-tls-verify=false \
            docker://${{ matrix.src }} \
            docker://${{ matrix.dst }}
