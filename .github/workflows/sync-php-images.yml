name: Sync PHP Base Images

on:
  workflow_dispatch:
    inputs:
      sync_php_base:
        description: "åŒæ­¥ PHP åŸºç¡€é•œåƒ (cli, fpm, simple-cli)"
        type: boolean
        default: true
      sync_php_octane:
        description: "åŒæ­¥ PHP Octane é•œåƒ (franken, roadrunner)"
        type: boolean
        default: false
      sync_php_xdebug:
        description: "åŒæ­¥ PHP Xdebug é•œåƒ (fpm-xdebug)"
        type: boolean
        default: false
      php_versions:
        description: "PHP ç‰ˆæœ¬ (é€—å·åˆ†éš”ï¼Œå¦‚: 8.4,8.5)"
        required: false
        type: string
        default: "8.4,8.5"
      tag:
        description: "é•œåƒå­æ ‡ç­¾ (å¦‚: latest)"
        required: false
        type: string
        default: "latest"

jobs:
  sync-php-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to Registries
        run: |
          # ç™»å½• Docker Hub (æº)
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | skopeo login \
            --username "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin \
            docker.io
          
          # ç™»å½• Tencent Registry (ç›®æ ‡)
          echo "${{ secrets.TENCENT_REGISTRY_PASSWORD }}" | skopeo login \
            --username "${{ secrets.TENCENT_REGISTRY_USERNAME }}" \
            --password-stdin \
            ccr.ccs.tencentyun.com

      - name: Sync PHP Images
        run: |
          # å®šä¹‰é•œåƒåˆ—è¡¨é€»è¾‘
          declare -A IMAGE_GROUPS
          IMAGE_GROUPS["php-base"]="php-base-cli,php-base-cli-trixie,php-base-fpm,php-base-fpm-trixie,php-base-simple-cli,php-base-simple-cli-trixie"
          IMAGE_GROUPS["php-octane"]="php-base-franken,php-base-franken-trixie,php-base-roadrunner,php-base-roadrunner-trixie"
          IMAGE_GROUPS["php-xdebug"]="php-base-fpm-xdebug,php-base-fpm-xdebug-trixie"

          PHPS_SYNC_BASE="${{ inputs.sync_php_base }}"
          PHPS_SYNC_OCTANE="${{ inputs.sync_php_octane }}"
          PHPS_SYNC_XDEBUG="${{ inputs.sync_php_xdebug }}"
          PHP_VERSIONS_INPUT="${{ inputs.php_versions }}"
          SUB_TAG="${{ inputs.tag }}"
          
          # è·å–å‘½åç©ºé—´ï¼ˆä¼˜å…ˆä½¿ç”¨ Secretsï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
          TARGET_NS="${{ secrets.TENCENT_REGISTRY_NAMESPACE }}"
          [ -z "$TARGET_NS" ] && TARGET_NS="jiaoio"
          
          IFS=',' read -ra VERSIONS <<< "$PHP_VERSIONS_INPUT"
          
          # ç¡®å®šè¦å¤„ç†çš„ç»„
          GROUPS=()
          [ "$PHPS_SYNC_BASE" == "true" ] && GROUPS+=("php-base")
          [ "$PHPS_SYNC_OCTANE" == "true" ] && GROUPS+=("php-octane")
          [ "$PHPS_SYNC_XDEBUG" == "true" ] && GROUPS+=("php-xdebug")

          if [ ${#GROUPS[@]} -eq 0 ]; then
            echo "âš ï¸ æœªé€‰æ‹©ä»»ä½•åŒæ­¥ç»„ï¼Œé€€å‡ºã€‚"
            exit 0
          fi

          for group in "${GROUPS[@]}"; do
            IFS=',' read -ra IMAGES <<< "${IMAGE_GROUPS[$group]}"
            for image in "${IMAGES[@]}"; do
              for version in "${VERSIONS[@]}"; do
                version=$(echo "$version" | xargs)
          
                # æ„é€  Tag ç­–ç•¥
                TAGS=()
                if [ "$group" == "php-xdebug" ]; then
                  TAGS=("$version-$SUB_TAG" "$version-fpm-$SUB_TAG" "$version-latest")
                else
                  TAGS=("$version-$SUB_TAG" "$version-latest")
                fi

                for tag in "${TAGS[@]}"; do
                  source_image="docker.io/jiaoio/${image}:${tag}"
                  target_image="ccr.ccs.tencentyun.com/${TARGET_NS}/${image}:${tag}"

                  echo "ğŸ”„ æ­£åœ¨åŒæ­¥: $source_image -> $target_image"

                  # ä½¿ç”¨ --all ç¡®ä¿åŒæ­¥æ‰€æœ‰æ¶æ„ï¼ˆamd64/arm64ï¼‰
                  if skopeo copy --all --src-tls-verify=false --dest-tls-verify=false \
                    docker://$source_image docker://$target_image; then
                    echo "âœ… åŒæ­¥æˆåŠŸ: ${image}:${tag}"
                  else
                    echo "âš ï¸ åŒæ­¥å¤±è´¥: ${image}:${tag} (å¯èƒ½é•œåƒå°šæœªæ¨é€åˆ°æºä»“åº“ï¼Œè·³è¿‡)"
                  fi
                done
              done
            done
          done
