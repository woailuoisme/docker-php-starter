name: Sync PHP Base Images

on:
  workflow_dispatch:
    inputs:
      sync_php_base:
        description: "åŒæ­¥ PHP åŸºç¡€é•œåƒ (cli, fpm, simple-cli)"
        type: boolean
        default: true
      sync_php_octane:
        description: "åŒæ­¥ PHP Octane é•œåƒ (franken, roadrunner)"
        type: boolean
        default: false
      sync_php_xdebug:
        description: "åŒæ­¥ PHP Xdebug é•œåƒ (fpm-xdebug)"
        type: boolean
        default: false
      php_versions:
        description: "PHP ç‰ˆæœ¬ (é€—å·åˆ†éš”ï¼Œå¦‚: 8.4,8.5)"
        required: false
        type: string
        default: "8.4,8.5"
      tag:
        description: "é•œåƒå­æ ‡ç­¾ (å¦‚: latest)"
        required: false
        type: string
        default: "latest"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # å®šä¹‰é•œåƒæ˜ å°„
          declare -A PHP_GROUPS
          PHP_GROUPS["php-base"]="php-base-cli,php-base-cli-trixie,php-base-fpm,php-base-fpm-trixie,php-base-simple-cli,php-base-simple-cli-trixie"
          PHP_GROUPS["php-octane"]="php-base-franken-trixie,php-base-roadrunner-trixie"
          PHP_GROUPS["php-xdebug"]="php-base-fpm-xdebug,php-base-fpm-xdebug-trixie"

          PHP_VERSIONS="${{ inputs.php_versions }}"
          SUB_TAG="${{ inputs.tag }}"

          MATRIX_JSON='{"include":[]}'

          # å¤„ç†é€»è¾‘: åªä¼ é€’éæ•æ„Ÿä¿¡æ¯åˆ° Matrix
          add_to_matrix() {
            local img=$1
            local tag=$2
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥é•œåƒå’Œæ ‡ç­¾çš„ç»„åˆï¼ˆç®€å•å»é‡ï¼‰
            if [[ "$MATRIX_JSON" == *"$img"* ]] && [[ "$MATRIX_JSON" == *"$tag"* ]]; then
              if echo "$MATRIX_JSON" | jq -e ".include[] | select(.img == \"$img\" and .tag == \"$tag\")" > /dev/null; then
                return
              fi
            fi
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ".include += [{\"img\":\"${img}\", \"tag\":\"${tag}\"}]")
          }

          IFS=',' read -ra VERSIONS <<< "$PHP_VERSIONS"
          
          # 1. åŸºç¡€é•œåƒ
          if [ "${{ inputs.sync_php_base }}" == "true" ]; then
            for img in ${PHP_GROUPS["php-base"]//,/ }; do
              for v in "${VERSIONS[@]}"; do
                v=$(echo $v | xargs)
                add_to_matrix "$img" "$v-latest"
                [ "$SUB_TAG" != "latest" ] && add_to_matrix "$img" "$v-$SUB_TAG"
              done
            done
          fi

          # 2. Octane é•œåƒ
          if [ "${{ inputs.sync_php_octane }}" == "true" ]; then
            for img in ${PHP_GROUPS["php-octane"]//,/ }; do
              for v in "${VERSIONS[@]}"; do
                v=$(echo $v | xargs)
                add_to_matrix "$img" "$v-latest"
                [ "$SUB_TAG" != "latest" ] && add_to_matrix "$img" "$v-$SUB_TAG"
              done
            done
          fi

          # 3. Xdebug é•œåƒ
          if [ "${{ inputs.sync_php_xdebug }}" == "true" ]; then
            for img in ${PHP_GROUPS["php-xdebug"]//,/ }; do
              for v in "${VERSIONS[@]}"; do
                v=$(echo $v | xargs)
                add_to_matrix "$img" "$v-latest"
                add_to_matrix "$img" "$v-fpm-$SUB_TAG" # ç‰¹æ®Šæ ‡ç­¾é€šå¸¸å¸¦ fpm
                [ "$SUB_TAG" != "latest" ] && add_to_matrix "$img" "$v-$SUB_TAG"
              done
            done
          fi

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Generated Matrix: $MATRIX_JSON"

  sync:
    needs: generate-matrix
    if: ${{ needs.generate-matrix.outputs.matrix != '' && contains(needs.generate-matrix.outputs.matrix, 'img') }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    
    name: Sync ${{ matrix.img }}:${{ matrix.tag }}
    steps:
      - name: Set up Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to Registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | skopeo login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin docker.io
          echo "${{ secrets.TENCENT_REGISTRY_PASSWORD }}" | skopeo login --username "${{ secrets.TENCENT_REGISTRY_USERNAME }}" --password-stdin ccr.ccs.tencentyun.com

      - name: Copy Image
        run: |
          # åœ¨æ‰§è¡Œé˜¶æ®µåŠ¨æ€è·å–æ•æ„Ÿä¿¡æ¯ï¼Œé¿å… Matrix è¢«è¿‡æ»¤
          TARGET_NS="${{ secrets.TENCENT_REGISTRY_NAMESPACE || 'jiaoio' }}"
          
          SKOPEO_SOURCE="docker://docker.io/jiaoio/${{ matrix.img }}:${{ matrix.tag }}"
          SKOPEO_TARGET="docker://ccr.ccs.tencentyun.com/${TARGET_NS}/${{ matrix.img }}:${{ matrix.tag }}"
          
          echo "ğŸ”„ æ­£åœ¨åŒæ­¥: ${{ matrix.img }}:${{ matrix.tag }}"
          
          skopeo copy \
            --all \
            --src-tls-verify=false \
            --dest-tls-verify=false \
            $SKOPEO_SOURCE \
            $SKOPEO_TARGET
