name: Build Group - PHP FPM Xdebug Images (8.4 & 8.5)

on:
  workflow_dispatch:
    inputs:
      # === ÊéßÂà∂ÂºÄÂÖ≥ ===
      build_all:
        description: 'üöÄ ÊûÑÂª∫ÊâÄÊúâ Xdebug ÈïúÂÉè'
        type: boolean
        default: false
      
      # === PHP 8.4 ===
      build_php84_alpine:
        description: 'PHP 8.4 FPM Xdebug (Alpine)'
        type: boolean
        default: false
      build_php84_trixie:
        description: 'PHP 8.4 FPM Xdebug (Trixie)'
        type: boolean
        default: false

      # === PHP 8.5 ===
      build_php85_alpine:
        description: 'PHP 8.5 FPM Xdebug (Alpine)'
        type: boolean
        default: false
      build_php85_trixie:
        description: 'PHP 8.5 FPM Xdebug (Trixie)'
        type: boolean
        default: false
      
      # === ÈÄöÁî®ÂèÇÊï∞ ===
      tag:
        description: 'ÈïúÂÉèÊ†áÁ≠æ (e.g., latest)'
        required: true
        default: 'latest'

env:
  REGISTRY_DOCKERHUB: docker.io/jiaoio
  REGISTRY_REDHAT: quay.io/jiaoio
  REGISTRY_TENCENT: ccr.ccs.tencentyun.com/jiaoio

jobs:
  # Èò∂ÊÆµ‰∏ÄÔºöÂä®ÊÄÅÁîüÊàê Matrix ÈÖçÁΩÆ
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # ÂàùÂßãÂåñ JSON Êï∞ÁªÑ
          MATRIX_JSON='[]'
          
          # ÂÆö‰πâËæÖÂä©ÂáΩÊï∞Êù•Ê∑ªÂä†‰ªªÂä°
          add_task() {
            local name=$1
            local context=$2
            local image=$3
            local version=$4
            # ÊûÑÈÄ† JSON ÂØπË±°Âπ∂ËøΩÂä†Âà∞Êï∞ÁªÑ
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ". + [{\"name\": \"$name\", \"context\": \"$context\", \"image\": \"$image\", \"version\": \"$version\"}]")
          }
          
          # ËØªÂèñËæìÂÖ•
          BUILD_ALL=${{ inputs.build_all }}
          
          # === PHP 8.4 ===
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_php84_alpine }}" == "true" ]; then
            add_task "php8.4-fpm-xdebug-alpine" "./php-base-fpm-xdebug" "php-base-fpm-xdebug" "8.4"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_php84_trixie }}" == "true" ]; then
            # Ê≥®ÊÑèÔºöÂ¶ÇÊûúÁõÆÂΩïÁªìÊûÑÊ≤°Êúâ php-base-fpm-xdebug-trixieÔºåËøôÈáåÈúÄË¶ÅÁ°ÆËÆ§
            # ÂÅáËÆæÁõÆÂΩïÁªìÊûÑÊòØÂ§çÁî®ÊàñËÄÖÊúâÂêÑËá™ÁöÑÁõÆÂΩï„ÄÇÊ†πÊçÆ‰πãÂâçÁöÑÊÉØ‰æãÔºåPHP 8.4 ÁöÑ trixie ‰ºº‰πéÊ≤°ÊúâÂçïÁã¨ÁöÑ xdebug ÁõÆÂΩïÔºü
            # ÊöÇÊó∂ÂÅáËÆæÊ≤øÁî® base-fpm-xdebug ÁõÆÂΩïÔºåÂõ†‰∏∫ Dockerfile ÂÜÖÈÉ®ÂèØËÉΩÈÄöËøá ARG ÊéßÂà∂ÔºåÊàñËÄÖ‰Ω†ÈúÄË¶ÅÁ°ÆËÆ§ÁõÆÂΩïÂêç
            # ËøôÈáåÂÖàÊåâÁÖßÊÉØ‰æãÊåáÂêë ./php-base-fpm-xdebug-trixie (Â¶ÇÊûú‰∏çÂ≠òÂú®ÈúÄË¶ÅÊñ∞Âª∫Êàñ‰øÆÊ≠£)
            # *‰øÆÊ≠£*ÔºöÊ†πÊçÆ‰πãÂâçÁöÑ ls ÂàóË°®Ôºåphp-base-fpm-xdebug ÁõÆÂΩï‰∏ãÂè™Êúâ Dockerfile„ÄÇ
            # Â¶ÇÊûúÊ≤°Êúâ trixie ‰∏ìÁî®ÁõÆÂΩïÔºåÂèØËÉΩÂ§çÁî®Âêå‰∏Ä‰∏™Âπ∂‰øÆÊîπ build arg?
            # ÊöÇÊó∂‰∏∫‰∫ÜÁ®≥Â¶•ÔºåÂÖàÊåáÂêë ./php-base-fpm-xdebugÔºåÂ¶ÇÊûúÈúÄË¶ÅÂå∫ÂàÜ trixie/alpine ÊòØÈÄöËøá Dockerfile ÂÜÖÁöÑ Base Image Á°ÆÂÆöÁöÑ
            # ‰ΩÜÈÄöÂ∏∏‰ºöÊúâ‰∏çÂêåÁöÑ Context ÁõÆÂΩï„ÄÇ
            # ÂÖàÊ£ÄÊü•‰∏Ä‰∏ãÁõÆÂΩïÁªìÊûÑ
            add_task "php8.4-fpm-xdebug-trixie" "./php-base-fpm-xdebug-trixie" "php-base-fpm-xdebug-trixie" "8.4"
          fi
          
          # === PHP 8.5 ===
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_php85_alpine }}" == "true" ]; then
            add_task "php8.5-fpm-xdebug-alpine" "./php8.5-base-fpm-xdebug" "php-base-fpm-xdebug" "8.5"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_php85_trixie }}" == "true" ]; then
            add_task "php8.5-fpm-xdebug-trixie" "./php8.5-base-fpm-xdebug-trixie" "php-base-fpm-xdebug-trixie" "8.5"
          fi
          
          # ËæìÂá∫ÊúÄÁªàÁöÑ JSON
          echo "matrix={\"include\":$MATRIX_JSON}" >> $GITHUB_OUTPUT
          echo "Generated Matrix: {\"include\":$MATRIX_JSON}"

  # Èò∂ÊÆµ‰∫åÔºö‰ΩøÁî®ÁîüÊàêÁöÑ Matrix Âπ∂Ë°åÊûÑÂª∫
  build-xdebug:
    needs: matrix-builder
    if: ${{ fromJson(needs.matrix-builder.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
    
    name: Build ${{ matrix.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.REDHAT_REGISTRY_TOKEN }}" | docker login quay.io -u "${{ secrets.REDHAT_REGISTRY_USERNAME }}" --password-stdin
          echo "${{ secrets.TENCENT_REGISTRY_PASSWORD }}" | docker login ccr.ccs.tencentyun.com -u "${{ secrets.TENCENT_REGISTRY_USERNAME }}" --password-stdin

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            CHANGE_SOURCE=false
            PHP_VERSION=${{ matrix.version }}
          push: true
          tags: |
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ matrix.version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ matrix.version }}-fpm-${{ inputs.tag }}
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ matrix.version }}-latest
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ matrix.version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ matrix.version }}-fpm-${{ inputs.tag }}
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ matrix.version }}-latest
            ${{ env.REGISTRY_TENCENT }}/${{ matrix.image }}:${{ matrix.version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_TENCENT }}/${{ matrix.image }}:${{ matrix.version }}-fpm-${{ inputs.tag }}
            ${{ env.REGISTRY_TENCENT }}/${{ matrix.image }}:${{ matrix.version }}-latest
