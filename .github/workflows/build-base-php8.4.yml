name: Build Group - PHP 8.4 Base Images

on:
  workflow_dispatch:
    inputs:
      # === æ§åˆ¶å¼€å…³ ===
      build_all:
        description: 'ğŸš€ æ„å»ºæ‰€æœ‰ PHP 8.4 é•œåƒ'
        type: boolean
        default: false
      
      build_cli_alpine:
        description: 'æ„å»º CLI (Alpine)'
        type: boolean
        default: false
      build_cli_trixie:
        description: 'æ„å»º CLI (Trixie)'
        type: boolean
        default: false
      build_fpm_alpine:
        description: 'æ„å»º FPM (Alpine)'
        type: boolean
        default: false
      build_fpm_trixie:
        description: 'æ„å»º FPM (Trixie)'
        type: boolean
        default: false
      build_simple_cli_alpine:
        description: 'æ„å»º Simple CLI (Alpine)'
        type: boolean
        default: false
      build_simple_cli_trixie:
        description: 'æ„å»º Simple CLI (Trixie)'
        type: boolean
        default: false
      
      # === é€šç”¨å‚æ•° ===
      php_version:
        description: "PHPç‰ˆæœ¬"
        required: true
        default: "8.4"
      tag:
        description: 'é•œåƒæ ‡ç­¾ (e.g., latest)'
        required: true
        default: 'latest'

env:
  REGISTRY_DOCKERHUB: docker.io/jiaoio
  REGISTRY_REDHAT: quay.io/jiaoio

jobs:
  # é˜¶æ®µä¸€ï¼šåŠ¨æ€ç”Ÿæˆ Matrix é…ç½®
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # åˆå§‹åŒ– JSON æ•°ç»„
          MATRIX_JSON='[]'
          
          # å®šä¹‰è¾…åŠ©å‡½æ•°æ¥æ·»åŠ ä»»åŠ¡
          add_task() {
            local name=$1
            local context=$2
            local image=$3
            local type=$4
            # æ„é€  JSON å¯¹è±¡å¹¶è¿½åŠ åˆ°æ•°ç»„
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ". + [{\"name\": \"$name\", \"context\": \"$context\", \"image\": \"$image\", \"type\": \"$type\"}]")
          }
          
          # åˆ¤æ–­é€»è¾‘ï¼šæ˜¯å¦æ„å»ºæ‰€æœ‰
          BUILD_ALL=${{ inputs.build_all }}
          
          # æ¡ä»¶åˆ¤æ–­å¹¶æ·»åŠ ä»»åŠ¡
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_cli_alpine }}" == "true" ]; then
            add_task "cli-alpine" "./php-base-cli" "php-base-cli" "cli"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_cli_trixie }}" == "true" ]; then
            add_task "cli-trixie" "./php-base-cli-trixie" "php-base-cli-trixie" "cli"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_fpm_alpine }}" == "true" ]; then
            add_task "fpm-alpine" "./php-base-fpm" "php-base-fpm" "fpm"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_fpm_trixie }}" == "true" ]; then
            add_task "fpm-trixie" "./php-base-fpm-trixie" "php-base-fpm-trixie" "fpm"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_simple_cli_alpine }}" == "true" ]; then
            add_task "simple-cli-alpine" "./php-base-simple-cli" "php-base-simple-cli" "cli"
          fi
          
          if [ "$BUILD_ALL" == "true" ] || [ "${{ inputs.build_simple_cli_trixie }}" == "true" ]; then
            add_task "simple-cli-trixie" "./php-base-simple-cli-trixie" "php-base-simple-cli-trixie" "cli"
          fi
          
          # è¾“å‡ºæœ€ç»ˆçš„ JSON
          echo "matrix={\"include\":$MATRIX_JSON}" >> $GITHUB_OUTPUT
          
          # æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
          echo "Generated Matrix: {\"include\":$MATRIX_JSON}"

  # é˜¶æ®µäºŒï¼šä½¿ç”¨ç”Ÿæˆçš„ Matrix å¹¶è¡Œæ„å»º
  build-php84:
    needs: matrix-builder
    # åªæœ‰å½“ matrix éç©ºæ—¶æ‰è¿è¡Œ
    if: ${{ fromJson(needs.matrix-builder.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
    
    name: Build ${{ matrix.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.REDHAT_REGISTRY_TOKEN }}" | docker login quay.io -u "${{ secrets.REDHAT_REGISTRY_USERNAME }}" --password-stdin

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            CHANGE_SOURCE=false
          push: true
          tags: |
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ inputs.php_version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ inputs.php_version }}-${{ matrix.type }}-${{ inputs.tag }}
            ${{ env.REGISTRY_DOCKERHUB }}/${{ matrix.image }}:${{ inputs.php_version }}-latest
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ inputs.php_version }}-${{ inputs.tag }}
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ inputs.php_version }}-${{ matrix.type }}-${{ inputs.tag }}
            ${{ env.REGISTRY_REDHAT }}/${{ matrix.image }}:${{ inputs.php_version }}-latest

