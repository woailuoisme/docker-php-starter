name: Build Caddy Base Multi-arch Images

on:
  workflow_dispatch:
    inputs:
      build_base:
        description: "是否构建 caddy-base (Stable 2.10.2)"
        type: boolean
        default: true
      caddy_base_version:
        description: "caddy-base 的版本标签"
        required: true
        default: "2.10.2"
      build_latest:
        description: "是否构建 caddy-base-latest (Edge 2.11.1)"
        type: boolean
        default: true
      caddy_latest_version:
        description: "caddy-base-latest 的版本标签"
        required: true
        default: "2.11.1"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          MATRIX_JSON='{"include":[]}'
          if [ "${{ github.event.inputs.build_base }}" == "true" ]; then
            MATRIX_JSON=$(echo $MATRIX_JSON | jq '.include += [{"name": "caddy-base", "dir": "caddy-base", "version": "${{ github.event.inputs.caddy_base_version }}"}]')
          fi
          if [ "${{ github.event.inputs.build_latest }}" == "true" ]; then
            MATRIX_JSON=$(echo $MATRIX_JSON | jq '.include += [{"name": "caddy-latest", "dir": "caddy-base-latest", "version": "${{ github.event.inputs.caddy_latest_version }}"}]')
          fi
          echo "matrix=$(echo $MATRIX_JSON | jq -c .)" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    if: fromJson(needs.prepare.outputs.matrix).include[0] != null
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ubuntu-latest
    env:
      REGISTRY_DOCKERHUB: docker.io/jiaoio
      REGISTRY_REDHAT: quay.io/jiaoio
      REPO_NAME: caddy-base
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to RedHat Registry
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.REDHAT_REGISTRY_USERNAME }}
          password: ${{ secrets.REDHAT_REGISTRY_TOKEN }}

      - name: Build and Push ${{ matrix.name }}
        run: |
          cd ${{ matrix.dir }} && docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-arg CHANGE_SOURCE=false \
            --tag $REGISTRY_DOCKERHUB/$REPO_NAME:${{ matrix.version }} \
            --tag $REGISTRY_REDHAT/$REPO_NAME:${{ matrix.version }} \
            --push \
            .
